<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dramabox - Ready to Deploy</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root {
            --bg-color: #0f0f13;
            --card-bg: #1e1e24;
            --primary: #e50914;
            --primary-hover: #f40612;
            --text: #ffffff;
            --text-sec: #b3b3b3;
            --nav-bg: rgba(20, 20, 25, 0.95);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        header {
            width: 100%;
            padding: 15px 40px;
            background-color: var(--nav-bg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .brand {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(45deg, #e50914, #ff6b6b);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
        }

        .nav-menu {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-item {
            color: var(--text-sec);
            text-decoration: none;
            font-weight: 500;
            font-size: 15px;
            transition: color 0.3s;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--text);
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #2a2a30;
            border-radius: 20px;
            padding: 5px 15px;
            border: 1px solid transparent;
            transition: all 0.3s;
        }

        .search-box:focus-within {
            border-color: var(--primary);
            background: #333;
        }

        input {
            background: transparent;
            border: none;
            color: white;
            padding: 8px;
            font-size: 14px;
            outline: none;
            width: 200px;
        }

        .category-bar {
            width: 100%;
            max-width: 1400px;
            display: flex;
            gap: 10px;
            padding: 15px 40px;
            overflow-x: auto;
            scrollbar-width: none;
        }

        .cat-chip {
            background: #2a2a30;
            color: var(--text-sec);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            white-space: nowrap;
            cursor: pointer;
            transition: 0.3s;
        }

        .cat-chip.active {
            background: var(--primary);
            color: white;
        }

        main {
            width: 100%;
            max-width: 1400px;
            padding: 20px 40px;
        }

        h2 {
            font-size: 22px;
            border-left: 4px solid var(--primary);
            padding-left: 15px;
            margin-bottom: 25px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-8px);
        }

        .card img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        .card-info {
            padding: 12px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: #eee;
            line-height: 1.4;
        }

        #player-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #player-overlay.active {
            display: flex;
        }

        .player-container {
            width: 100%;
            max-width: 450px;
            aspect-ratio: 9/16;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .chapter-list {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            width: 90%;
            max-width: 800px;
            padding: 20px 0;
        }

        .chapter-item {
            min-width: 50px;
            height: 50px;
            background: #2a2a30;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
        }

        .chapter-item.current {
            background: var(--primary);
            color: white;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            display: none;
            margin: 40px auto;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="brand" onclick="loadLatest()">FIX DRAMABOX</div>
        <nav class="nav-menu">
            <a onclick="loadLatest()" class="nav-item active">Beranda</a>
            <a onclick="loadRank()" class="nav-item">Trending</a>
            <a onclick="loadComingSoon()" class="nav-item">Coming Soon</a>
        </nav>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Cari film...">
            <button style="background:none; border:none; color:white; cursor:pointer;" onclick="doSearch()">üîç</button>
        </div>
    </header>

    <main>
        <h2 id="sectionTitle">Terbaru Tayang</h2>
        <div id="loader" class="loader"></div>
        <div id="grid" class="grid"></div>
    </main>

    <div id="player-overlay">
        <div class="close-btn" onclick="closePlayer()">‚úï</div>
        <div class="player-container">
            <video id="videoPlayer" controls autoplay playsinline loop></video>
        </div>
        <h3 id="playerTitle" style="margin-top:15px;">Judul</h3>
        <div class="chapter-list" id="chapterList"></div>
    </div>

    <script>
        let currentBookId = null;
        let currentChapters = [];
        let currentIndex = 1;
        let hls = null;

        window.onload = () => loadLatest();

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // MEMANGGIL FILE JSON STATIS DARI FOLDER PUBLIC
        async function loadData(fileName) {
            showLoader(true);
            try {
                const res = await fetch(`/${fileName}`); // Mencari di folder public
                if (!res.ok) throw new Error('File tidak ditemukan');
                const data = await res.json();
                renderGrid(data.data || data);
            } catch (e) {
                console.error("Gagal load data:", e);
                document.getElementById('grid').innerHTML = `<p style="color:red; text-align:center;">Gagal memuat data ${fileName}. Pastikan file ada di folder public.</p>`;
            }
            showLoader(false);
        }

        function loadLatest() {
            document.getElementById('sectionTitle').innerText = 'Terbaru Tayang';
            loadData('latest_already_aired.json?v=2');
        }

        function loadRank() {
            document.getElementById('sectionTitle').innerText = 'Sedang Trending';
            loadData('rank_all_fitur.json');
        }

        function loadComingSoon() {
            document.getElementById('sectionTitle').innerText = 'Segera Tayang';
            loadData('latest_coming_soon.json');
        }

        function renderGrid(items) {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            if (!items) return;
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.onclick = () => openBook(item.bookId || item.id, item.bookName || item.name);
                const img = item.coverWap || item.cover || 'https://via.placeholder.com/200x300';
                card.innerHTML = `
                    <img src="${img}">
                    <div class="card-info"><div class="card-title">${item.bookName || item.name}</div></div>
                `;
                grid.appendChild(card);
            });
        }

        async function openBook(bookId, title) {
            currentBookId = bookId;
            document.getElementById('playerTitle').innerText = title;
            document.getElementById('player-overlay').classList.add('active');

            try {
                // 1. Coba cari file spesifik
                let res = await fetch(`/chapter_dump_${bookId}.json`);

                // 2. Jika 404 (tidak ketemu), pakai file default
                if (!res.ok) {
                    console.warn(`File chapter_dump_${bookId}.json tidak ada (404), switch ke fallback default.`);
                    res = await fetch('/chapter_dump.json');
                }

                // 3. Jika masih error juga, baru lempar exception
                if (!res.ok) throw new Error("File chapter default juga tidak ditemukan!");

                const data = await res.json();
                if (data.data && data.data.chapters) {
                    currentChapters = data.data.chapters;
                    renderChapterList();
                    playChapter(1);
                }
            } catch (e) {
                console.error("OpenBook Error:", e);
                alert("Maaf, data chapter untuk film ini belum tersedia.");
            }
        }

        function renderChapterList() {
            const list = document.getElementById('chapterList');
            list.innerHTML = '';
            currentChapters.forEach((ch, idx) => {
                const btn = document.createElement('div');
                btn.className = 'chapter-item' + (idx + 1 === currentIndex ? ' current' : '');
                btn.innerText = idx + 1;
                btn.onclick = () => playChapter(idx + 1);
                list.appendChild(btn);
            });
        }

        function playChapter(index) {
            currentIndex = index;
            renderChapterList();
            const chapter = currentChapters[index - 1];
            if (chapter && chapter.cdnList && chapter.cdnList[0].videoPathList) {
                const url = chapter.cdnList[0].videoPathList[0].videoPath;
                playVideo(url);
            }
        }

        function playVideo(url) {
            const video = document.getElementById('videoPlayer');
            if (Hls.isSupported() && url.includes('.m3u8')) {
                if (hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else {
                video.src = url;
                video.play();
            }
        }

        function closePlayer() {
            document.getElementById('player-overlay').classList.remove('active');
            const video = document.getElementById('videoPlayer');
            video.pause();
            if (hls) hls.destroy();
        }

        function doSearch() {
            const kw = document.getElementById('searchInput').value.toLowerCase();
            // Pencarian sederhana di file rank_all_fitur sebagai database sementara
            fetch('/rank_all_fitur.json').then(r => r.json()).then(data => {
                const results = data.data.filter(i => (i.bookName || i.name).toLowerCase().includes(kw));
                renderGrid(results);
                document.getElementById('sectionTitle').innerText = `Hasil Cari: ${kw}`;
            });
        }
    </script>
</body>

</html>